#!/usr/bin/env bash

source "${BASH_SOURCE%/*}/.helpers.sh"

docker_compose_shared up -d

# Wait for postgres to come up.
docker_compose_shared exec postgres \
  bash -c 'while ! pg_isready --quiet; do sleep 1; done;'

for ENV in development test
do
  # Create database if it doesn't already exist.
  docker_compose_shared exec postgres \
    su - postgres -c "psql $ENV -c '' || createdb $ENV"

  docker_compose_in_env build
  docker_compose_in_env run --rm todo npx knex migrate:latest
done

ENV=development docker_compose_in_env up -d
